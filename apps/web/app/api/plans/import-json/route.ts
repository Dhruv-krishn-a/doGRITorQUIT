// apps/web/app/api/plans/import-json/route.ts
import { NextResponse } from "next/server";
import { createServerClient } from "@supabase/ssr";
import { cookies } from "next/headers";
import { prisma } from "@/lib/prisma";

// Use domain imports (you already have the domain package)
import { plans as planDomain } from "@domain";
import { getUserTier, canUseAIGeneration } from "@domain/billing/entitlements";

export async function POST(req: Request) {
  try {
    // read cookies (server components)
    const cookieStore = await cookies();

    const supabase = createServerClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL!,
      process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
      {
        cookies: {
          getAll() {
            return cookieStore.getAll();
          },
          setAll() {
            /* read-only in this route */
          },
        },
      }
    );

    const { data: { session } } = await supabase.auth.getSession();
    if (!session?.user) {
      return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
    }

    const supabaseUserId = session.user.id;
    const userEmail = session.user.email;
    if (!supabaseUserId || !userEmail) {
      return NextResponse.json({ error: "Invalid user session" }, { status: 401 });
    }

    // Ensure user exists in our DB - upsert would be nicer but keep simple
    let user = await prisma.user.findUnique({ where: { id: supabaseUserId } });
    if (!user) {
      user = await prisma.user.create({
        data: {
          id: supabaseUserId,
          email: userEmail,
          name: session.user.user_metadata?.name || userEmail.split("@")[0],
        },
      });
    }

    const body = await req.json();
    const { planName, tasks, isAI } = body ?? {};

    if (!planName) {
      return NextResponse.json({ error: "Missing planName" }, { status: 400 });
    }
    if (!Array.isArray(tasks)) {
      return NextResponse.json({ error: "Bad tasks payload" }, { status: 400 });
    }

    // If this import was generated by AI, enforce entitlement (server-side)
    if (isAI) {
      const tier = await getUserTier(user.id);
      if (!canUseAIGeneration(tier)) {
        return NextResponse.json(
          { error: "Upgrade required to use AI plan generation" },
          { status: 403 }
        );
      }
    }

    // Delegate the heavy lifting to domain service (transactional)
    // This centralizes logic and keeps route thin.
    const createdPlan = await planDomain.importPlanJson(user.id, planName, tasks);

    // Optionally: return the created plan (domain currently returns the plan record)
    return NextResponse.json(createdPlan, { status: 201 });
  } catch (error: any) {
    console.error("Import JSON error:", error);

    // Prisma foreign key errors etc
    if (error?.code === "P2003") {
      return NextResponse.json(
        { error: "Database constraint violation. Please ensure your account is properly set up." },
        { status: 400 }
      );
    }

    if (error?.code === "ENTITLEMENT_LIMIT") {
      return NextResponse.json({ error: error.message }, { status: 403 });
    }

    return NextResponse.json(
      { error: "Internal Server Error", details: error.message || String(error) },
      { status: 500 }
    );
  }
}
